<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OneMachine CtrlBx - Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #121212;
      --glass-bg: rgba(255, 255, 255, 0.1);
      --glass-border: rgba(255, 255, 255, 0.2);
      --accent-color: #00bcd4;
      --text-color: #ffffff;
      --text-muted: #aaaaaa;
      --success: #4caf50;
      --danger: #f44336;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      background: linear-gradient(45deg, #1a1a1a, #2d2d2d);
      min-height: 100vh;
    }

    /* GLASSMORPHISM UTILS */
    .glass {
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    /* LOGIN SCREEN */
    #login-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .login-box {
      width: 300px;
      padding: 40px;
      text-align: center;
    }

    /* NAV */
    nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 30px;
      margin-bottom: 30px;
    }

    .logo {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--accent-color);
    }

    .nav-links button {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 1rem;
      margin-left: 20px;
      cursor: pointer;
      font-family: inherit;
      padding: 5px 10px;
      transition: color 0.3s;
    }

    .nav-links button.active {
      color: var(--text-color);
      border-bottom: 2px solid var(--accent-color);
    }

    .nav-links button:hover {
      color: var(--text-color);
    }

    /* SECTIONS */
    .section {
      display: none;
      animation: fadeIn 0.5s;
    }

    .section.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* DASHBOARD */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .card {
      padding: 20px;
      text-align: center;
    }

    .card h3 {
      margin: 0;
      font-size: 2.5rem;
      color: var(--accent-color);
    }

    .card p {
      margin: 5px 0 0;
      color: var(--text-muted);
    }

    /* TABLES */
    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th {
      text-align: left;
      padding: 15px;
      color: var(--text-muted);
      border-bottom: 1px solid var(--glass-border);
    }

    td {
      padding: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .status-dot {
      height: 10px;
      width: 10px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 5px;
    }

    .online {
      background-color: var(--success);
      box-shadow: 0 0 5px var(--success);
    }

    .offline {
      background-color: var(--danger);
    }

    /* BUTTONS */
    .btn {
      background: var(--accent-color);
      color: #000;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: opacity 0.3s;
    }

    .btn:hover {
      opacity: 0.8;
    }

    .btn-sm {
      padding: 4px 8px;
      font-size: 0.8rem;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    /* INPUTS */
    input,
    select {
      width: 100%;
      box-sizing: border-box;
      padding: 10px;
      margin: 10px 0;
      background: #2d2d2d;
      border: 1px solid #444;
      color: white;
      border-radius: 5px;
    }

    /* MODAL */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-content {
      background: #1e1e1e;
      padding: 30px;
      width: 90%;
      max-width: 400px;
    }

    /* LOADING */
    .loader {
      text-align: center;
      padding: 20px;
      color: var(--text-muted);
    }
  </style>
</head>

<body>

  <!-- LOGIN SCREEN -->
  <div id="login-screen">
    <div class="login-box glass">
      <h2>Admin Login</h2>
      <input type="password" id="api-key" placeholder="Enter API Key (admin123)">
      <input type="text" id="backend-url" placeholder="Backend URL (Script App URL)">
      <button class="btn" onclick="login()" style="width:100%; margin-top:20px">Login</button>
    </div>
  </div>

  <!-- NAV -->
  <nav class="glass">
    <div class="logo">OneMachine CtrlBx</div>
    <div class="nav-links">
      <button onclick="showSection('dashboard')" class="active" id="btn-dashboard">Dashboard</button>
      <button onclick="showSection('users')" id="btn-users">Users</button>
      <button onclick="showSection('devices')" id="btn-devices">Devices</button>
      <button onclick="showSection('logs')" id="btn-logs">Logs</button>
      <button onclick="logout()" style="color: var(--danger)">Logout</button>
    </div>
  </nav>

  <div class="container">

    <!-- DASHBOARD -->
    <div id="dashboard" class="section active">
      <div class="dashboard-grid">
        <div class="card glass">
          <h3 id="stat-devices">-</h3>
          <p>Total Devices</p>
        </div>
        <div class="card glass">
          <h3 id="stat-users">-</h3>
          <p>Total Users</p>
        </div>
      </div>

      <h3>Recent Activity</h3>
      <div class="glass table-container">
        <table id="table-recent-logs">
          <thead>
            <tr>
              <th>Time</th>
              <th>User</th>
              <th>Device</th>
              <th>Event</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="4" class="loader">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- USERS -->
    <div id="users" class="section">
      <div style="display:flex; justify-content:space-between; align-items:center">
        <h3>Users Management</h3>
        <button class="btn" onclick="refreshUsers()">Refresh</button>
      </div>
      <div class="glass table-container">
        <table id="table-users">
          <thead>
            <tr>
              <th>UID</th>
              <th>Name</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- DEVICES -->
    <div id="devices" class="section">
      <div style="display:flex; justify-content:space-between; align-items:center">
        <h3>Devices Status</h3>
        <button class="btn" onclick="refreshDevices()">Refresh</button>
      </div>
      <div class="glass table-container">
        <table id="table-devices">
          <thead>
            <tr>
              <th>ID</th>
              <th>Location</th>
              <th>Type</th>
              <th>Status</th>
              <th>Last Seen</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- LOGS -->
    <div id="logs" class="section" style="text-align: center;">
      <p>Log view is limited in V1. Check Google Sheet for full history.</p>
    </div>

  </div>

  <!-- MODAL TOKEN -->
  <div id="modal-tokens" class="modal">
    <div class="glass modal-content">
      <h3>Manage Tokens</h3>
      <p id="modal-user-name">User: ...</p>
      <input type="hidden" id="modal-uid">

      <label>Token Type</label>
      <select id="modal-token-type">
        <option value="WSH">WSH (Wash)</option>
        <option value="DRY">DRY (Dryer)</option>
        <!-- Add dynamic types later -->
      </select>

      <label>Action</label>
      <div style="display:flex; gap:10px;">
        <button class="btn" onclick="adjustTokens(1)">+1</button>
        <button class="btn" onclick="adjustTokens(5)">+5</button>
        <button class="btn btn-danger" onclick="adjustTokens(-1)">-1</button>
      </div>
      <p style="margin-top:10px; font-size:0.9rem; color:#aaa;">Changes are auto-saved.</p>

      <button class="btn" onclick="closeModal()" style="margin-top:20px; width:100%; background:#444;">Close</button>
    </div>
  </div>

  <script>
    // --- APP STATE ---
    let API_URL = localStorage.getItem('backend_url') || "";
    let AUTH_KEY = localStorage.getItem('auth_key') || "";

    // --- AUTH ---
    function checkAuth() {
      if (API_URL && AUTH_KEY) {
        document.getElementById('login-screen').style.display = 'none';
        loadDashboard(); // Init
      } else {
        document.getElementById('login-screen').style.display = 'flex';
        if (API_URL) document.getElementById('backend-url').value = API_URL;
      }
    }

    function login() {
      const key = document.getElementById('api-key').value;
      const url = document.getElementById('backend-url').value;
      if (!key || !url) return alert("Fill all fields");

      localStorage.setItem('auth_key', key);
      localStorage.setItem('backend_url', url);

      API_URL = url;
      AUTH_KEY = key;

      document.getElementById('login-screen').style.display = 'none';
      loadDashboard();
    }

    function logout() {
      localStorage.removeItem('auth_key');
      location.reload();
    }

    // --- API HELPER ---
    async function apiCall(action, params = {}) {
      const payload = {
        action: action,
        auth_key: AUTH_KEY,
        ...params
      };

      try {
        // Using POST with text/plain to avoid preflight (Simple Request) in some cases,
        // or standard JSON. Apps Script usually handles redirects for POST.
        // We use standard fetch.
        const response = await fetch(API_URL, {
          method: 'POST',
          // redirect: "follow", // Apps Script redirects
          body: JSON.stringify(payload)
        });

        const data = await response.json();
        if (data.error) throw new Error(data.error);
        return data;
      } catch (e) {
        console.error(e);
        if (e.message.includes('UNAUTHORIZED')) {
          alert("Unauthorized! Check API Key.");
          logout();
        }
        alert("API Error: " + e.message);
        throw e;
      }
    }

    // --- NAV LOGIC ---
    function showSection(id) {
      document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
      document.getElementById(id).classList.add('active');

      document.querySelectorAll('.nav-links button').forEach(el => el.classList.remove('active'));
      document.getElementById('btn-' + id).classList.add('active');

      if (id === 'dashboard') loadDashboard();
      if (id === 'users') refreshUsers();
      if (id === 'devices') refreshDevices();
    }

    // --- FEATURES ---

    // DASHBOARD
    async function loadDashboard() {
      if (!API_URL) return;
      try {
        const data = await apiCall('getDashboardData');
        document.getElementById('stat-users').innerText = data.stats.users;
        document.getElementById('stat-devices').innerText = data.stats.devices;

        const tbody = document.querySelector('#table-recent-logs tbody');
        tbody.innerHTML = '';
        data.recentLogs.reverse().forEach(log => {
          const date = new Date(log[0]).toLocaleString();
          tbody.innerHTML += `<tr>
                 <td>${date}</td>
                 <td>${log[2]}</td>
                 <td>${log[3]}</td>
                 <td><span style="color: ${log[5] == 'ACCESS_GRANTED' ? 'var(--success)' : '#fff'}">${log[5]}</span></td>
               </tr>`;
        });
      } catch (e) { }
    }

    // USERS
    async function refreshUsers() {
      const tbody = document.querySelector('#table-users tbody');
      tbody.innerHTML = '<tr><td colspan="4" class="loader">Loading...</td></tr>';

      try {
        const users = await apiCall('getUsersData');
        tbody.innerHTML = '';
        users.forEach(u => {
          tbody.innerHTML += `<tr>
             <td>${u.uid}</td>
             <td>${u.name}</td>
             <td>${u.status}</td>
             <td>
               <button class="btn btn-sm" onclick="openTokenModal('${u.uid}', '${u.name}')">Tokens</button>
             </td>
           </tr>`;
        });
      } catch (e) { tbody.innerHTML = '<tr><td colspan="4">Error</td></tr>'; }
    }

    // DEVICES
    async function refreshDevices() {
      const tbody = document.querySelector('#table-devices tbody');
      tbody.innerHTML = '<tr><td colspan="6" class="loader">Loading...</td></tr>';

      try {
        const devices = await apiCall('getDevicesData');
        tbody.innerHTML = '';
        devices.forEach(d => {
          const onlineDot = d.online ? 'online' : 'offline';

          tbody.innerHTML += `<tr>
             <td>${d.id}</td>
             <td>${d.location}</td>
             <td>${d.type}</td>
             <td>${d.active ? 'Active' : 'Inactive'}</td>
             <td>
               <span class="status-dot ${onlineDot}"></span>
               ${d.last_seen ? new Date(d.last_seen).toLocaleTimeString() : 'Never'}
             </td>
             <td>
               <button class="btn btn-sm" onclick="toggleDevice('${d.id}', ${!d.active})">
                 ${d.active ? 'Disable' : 'Enable'}
               </button>
             </td>
           </tr>`;
        });
      } catch (e) { tbody.innerHTML = '<tr><td colspan="6">Error</td></tr>'; }
    }

    // TOKENS
    function openTokenModal(uid, name) {
      document.getElementById('modal-uid').value = uid;
      document.getElementById('modal-user-name').innerText = 'User: ' + name;
      document.getElementById('modal-tokens').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('modal-tokens').style.display = 'none';
      refreshUsers();
    }

    async function adjustTokens(amount) {
      const uid = document.getElementById('modal-uid').value;
      const type = document.getElementById('modal-token-type').value;
      const btn = event.target;
      const originalText = btn.innerText;

      btn.innerText = '...';
      try {
        await apiCall('updateUserBalance', { uid, type, delta: amount });
        btn.innerText = originalText;
        // Optionally show success toast
      } catch (e) {
        btn.innerText = originalText;
      }
    }

    async function toggleDevice(id, active) {
      if (!confirm("Are you sure?")) return;
      try {
        await apiCall('toggleDeviceState', { esp32Id: id, active });
        refreshDevices();
      } catch (e) { }
    }

    // INIT
    window.onload = checkAuth;

  </script>
</body>

</html>